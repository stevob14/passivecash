<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Live Bitcoin (BTC), Ethereum (ETH), and Solana (SOL) price tickers, historical charts, and latest news feeds from PassiveCash.xyz.">
    <title>Crypto Tickers & Charts - PassiveCash.xyz</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q203YEXP0D"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-Q203YEXP0D');
    </script>
    <link rel="preload" href="style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="style.css"></noscript>
    <!-- Social Media Meta Tags -->
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.passivecash.xyz/crypto.html">
    <meta property="og:title" content="Crypto Tickers & Charts - PassiveCash.xyz">
    <meta property="og:description" content="Live Bitcoin (BTC), Ethereum (ETH), and Solana (SOL) price tickers, historical charts, and latest news feeds from PassiveCash.xyz.">
    <meta property="og:image" content="https://www.passivecash.xyz/images/logo.jpg">
    <meta property="og:site_name" content="PassiveCash.xyz">
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://www.passivecash.xyz/crypto.html">
    <meta name="twitter:title" content="Crypto Tickers & Charts - PassiveCash.xyz">
    <meta name="twitter:description" content="Live Bitcoin (BTC), Ethereum (ETH), and Solana (SOL) price tickers, historical charts, and latest news feeds from PassiveCash.xyz.">
    <meta name="twitter:image" content="https://www.passivecash.xyz/images/logo.jpg">
</head>
<body>
    <nav class="navbar">
        <div class="container">
             <a href="index.html" class="logo">PassiveCash.xyz</a>
             <!-- Hamburger Button -->
             <button id="hamburger-btn" aria-label="Toggle Navigation Menu" aria-expanded="false">
                 <span class="bar"></span>
                 <span class="bar"></span>
                 <span class="bar"></span>
             </button>
             <!-- Navigation Links -->
            <ul id="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="calculators.html">Calculators</a></li>
                <li><a href="crypto.html" class="active">Crypto</a></li>
                <li><a href="market.html">Market</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="disclaimer.html">Disclaimer</a></li>
            </ul>
        </div>
    </nav>

    <!-- Advertisement Bar -->
    <div id="advertisement"></div>

    <div class="content-container">
        <div id="crypto-selector-container">
            <button id="crypto-menu-trigger">Bitcoin (BTC)</button> <!-- Trigger Button -->
            <div id="crypto-menu"> <!-- Dropdown Menu -->
                <button class="crypto-option" data-target="btc-section" data-display="Bitcoin (BTC)">Bitcoin (BTC)</button>
                <button class="crypto-option" data-target="eth-section" data-display="Ethereum (ETH)">Ethereum (ETH)</button>
                <button class="crypto-option" data-target="sol-section" data-display="Solana (SOL)">Solana (SOL)</button>
                <button class="crypto-option" data-target="market-table-section" data-display="Market Table">Market Table</button> <!-- Added Market Table option -->
            </div>
        </div>

<div id="btc-section" class="crypto-section crypto-content active">
    <!-- Removed H2 Title -->
    <span class="BtcPrice loading-text">Loading price...</span> <!-- Use unique class, Added loading-text -->
    <p>Bitcoin is the first decentralized cryptocurrency that consists of peer-to-peer transactions that are verified and recorded in a public blockchain. What is unique about Bitcoin is the ability to act as a currency outside the control of any person, group, or entity. Get free Bitcoin worth $20 by signing up at <a href="https://coinbase.com/join/MG2TWZF" target="_blank">Coinbase-Referral</a>.</p>
    <div id="chart" class="chart-container"></div> <!-- Target for btc_chart.js -->
    <p style="font-size: 0.8em; text-align: center; color: #aaa; margin-top: 5px; margin-bottom: 15px;">
        Chart data provided by <a href="https://www.coingecko.com/en/api" target="_blank">CoinGecko API</a>.
    </p>
    <div id="btc-rss-feed" class="rss-feed-container">
        <h4>Bitcoin Latest News</h4>
        <div class="feed-items"><!-- RSS feed content will be loaded here --></div>
    </div>
</div>

<div id="eth-section" class="crypto-section crypto-content">
    <!-- Removed H2 Title -->
    <span class="EthPrice loading-text">Loading price...</span> <!-- Use unique class, Added loading-text -->
    <p>Ethereum is the first decentralized blockchain network that can run smart contracts and is powered by the ETH cryptocurrency. Smart contracts are applications that run exactly as programmed without any chance of censorship, fraud or third-party interference. What makes this unique is the ability of developers to build custom smart contracts for various applications using the Ethereum network. For example, you can earn interest on your holdings using <a href="index.html#crypto-interest">DeFi</a> applications built using the Ethereum network.</p>
    <div id="chart-eth" class="chart-container"></div> <!-- Use unique ID -->
    <p style="font-size: 0.8em; text-align: center; color: #aaa; margin-top: 5px; margin-bottom: 15px;">
        Chart data provided by <a href="https://www.coingecko.com/en/api" target="_blank">CoinGecko API</a>.
    </p>
    <div id="eth-rss-feed" class="rss-feed-container">
        <h4>Ethereum Latest News</h4>
        <div class="feed-items"><!-- RSS feed content will be loaded here --></div>
    </div>
</div>

<div id="sol-section" class="crypto-section crypto-content">
    <!-- Placeholder Title/Content -->
    <span class="SolPrice loading-text">Loading price...</span> <!-- Use unique class, Added loading-text -->
    <p>Solana is a high-performance blockchain supporting builders around the world creating crypto apps that scale today. It is known for its speed and low transaction costs, enabling a wide range of applications, including <a href="index.html#crypto-interest">DeFi</a> platforms where you can potentially earn interest on your SOL holdings.</p>
    <div id="chart-sol" class="chart-container"></div> <!-- Use unique ID -->
    <p style="font-size: 0.8em; text-align: center; color: #aaa; margin-top: 5px; margin-bottom: 15px;">
        Chart data provided by <a href="https://www.coingecko.com/en/api" target="_blank">CoinGecko API</a>.
    </p>
    <div id="sol-rss-feed" class="rss-feed-container">
        <h4>Solana Latest News</h4>
        <div class="feed-items"><!-- RSS feed content will be loaded here --></div>
        <!-- RSS feed content will be loaded here -->
    </div>
</div>

<div id="market-table-section" class="crypto-section crypto-content"> <!-- Added container for market table -->
    <!-- Removed H2 Title -->
    <div id="crypto-market-table-container">
        <!-- Market table will be loaded here by js/market_table.js -->
    </div>
    <p style="font-size: 0.8em; text-align: center; color: #aaa; margin-top: 15px;">
        Market data provided by <a href="https://www.coingecko.com/en/api" target="_blank">CoinGecko API</a>. Updated every 5 minutes (cached).
    </p>
</div>

    </div>

    <!-- Include jQuery and Highstock (for charts) -->
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/highstock.js"></script>
    <!-- Include Crypto JS files -->
    <script src="js/linear_regression.js"></script> <!-- Uncommented and moved up -->
    <script src="js/ticker.js"></script> <!-- Unified ticker script -->
    <script src="js/chart.js"></script>  <!-- Unified chart script -->
    <!-- Removed old btc/eth specific ticker and chart scripts -->

    <script>
        // Define baseTitle and updatePageTitle globally BEFORE document.ready
        const baseTitle = document.title; // Store base title globally

        // --- Function to update page title --- (Now Global)
        // Accepts cryptoType directly
        function updatePageTitle(cryptoType, price) {
            // console.log(`updatePageTitle called: cryptoType=${cryptoType}, price=${price}, baseTitle=${baseTitle}`); // DEBUG LOG removed
            if (price && cryptoType) {
                const formattedPrice = parseFloat(price).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                const newTitle = `${cryptoType.toUpperCase()} ${formattedPrice} - PassiveCash.xyz`;
                // console.log(`Setting title to: ${newTitle}`); // DEBUG LOG removed
                document.title = newTitle;
            } else {
                // console.log(`Resetting title to baseTitle: ${baseTitle}`); // DEBUG LOG removed
                document.title = baseTitle; // Reset on error or missing info
            }
        }

        // Placeholder for potential page-specific initialization if needed
        $(document).ready(function() {
            console.log("Crypto page loaded.");
            let activePriceIntervalId = null; // Variable to hold the active interval ID
            // baseTitle is now global
            // --- Function to start/switch the active price ticker ---
            function startTicker(cryptoType) {
                console.log("Starting ticker for:", cryptoType); // Debug log
                // Clear any existing interval
                if (activePriceIntervalId) {
                    clearInterval(activePriceIntervalId);
                    activePriceIntervalId = null;
                    console.log("Cleared previous interval"); // Debug log
                }

                // Determine the correct price element selector based on cryptoType
                let priceSelector;
                if (cryptoType === 'btc') {
                    priceSelector = '.BtcPrice';
                } else if (cryptoType === 'eth') {
                    priceSelector = '.EthPrice';
                } else if (cryptoType === 'sol') {
                    priceSelector = '.SolPrice';
                } else {
                     console.error("Cannot determine priceSelector in startTicker for:", cryptoType);
                     return; // Don't proceed if type is unknown
                }

                // Use the unified ticker function, passing the selector
                get_crypto_price(cryptoType, priceSelector); // Call once immediately
                activePriceIntervalId = setInterval(() => get_crypto_price(cryptoType, priceSelector), 1000); // Set interval
                console.log(`Started ${cryptoType.toUpperCase()} interval:`, activePriceIntervalId); // Debug log
            }

            // --- Custom Dropdown Logic ---
            const cryptoMenuTrigger = $('#crypto-menu-trigger');
            const cryptoMenu = $('#crypto-menu');
            const cryptoOptions = $('#crypto-menu .crypto-option'); // Buttons within the menu
            const cryptoSections = $('.crypto-content'); // The content sections (btc-section, eth-section)

            // Toggle dropdown visibility
            cryptoMenuTrigger.on('click', function(e) {
                e.stopPropagation(); // Prevent click from immediately closing menu
                cryptoMenu.toggleClass('active');
            });

            // --- Function to fetch and display RSS feed ---
            async function fetchAndDisplayRSS(feedUrl, containerId) {
                const feedItemsContainer = $(`#${containerId} .feed-items`); // Target the inner div
                const cacheKey = `rss_feed_${feedUrl}`;
                const cacheDuration = 15 * 60 * 1000; // 15 minutes in milliseconds

                // Try loading from cache first
                try {
                    const cachedData = sessionStorage.getItem(cacheKey);
                    if (cachedData) {
                        const { timestamp, htmlContent } = JSON.parse(cachedData);
                        const now = Date.now();
                        if (now - timestamp < cacheDuration) {
                            console.log(`Using cached RSS feed for ${feedUrl}`);
                            feedItemsContainer.html(htmlContent);
                            return; // Exit function, cache is valid
                        } else {
                             console.log(`Cache expired for ${feedUrl}`);
                        }
                    }
                } catch (e) {
                    console.error("Error reading RSS cache:", e);
                    // Proceed to fetch if cache read fails
                }

                // If cache is invalid or doesn't exist, fetch new data
                feedItemsContainer.html('<p class="loading-text">Loading news...</p>'); // Show loading state in the inner div, Added loading-text class

                // Using api.rss2json.com to convert RSS to JSON
                const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}`;

                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data.status !== 'ok') {
                        throw new Error(`rss2json API error: ${data.message || 'Failed to fetch feed'}`);
                    }

                    const items = data.items;
                    let htmlContent = '<ul>';
                    let count = 0;

                    if (items && items.length > 0) {
                        items.forEach(item => {
                            if (count >= 5) return; // Limit to 5 news items
                            const title = item.title || 'No title';
                            const link = item.link || '#';
                            htmlContent += `<li><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></li>`;
                            count++;
                        });
                    }

                    htmlContent += '</ul>';

                    if (count === 0) {
                        htmlContent = '<p>News feed is empty or could not be loaded.</p>'; // Store empty message too
                    }

                    // Display the fetched content
                    feedItemsContainer.html(htmlContent);

                    // Store the fetched content and timestamp in cache
                    try {
                        const cachePayload = JSON.stringify({ timestamp: Date.now(), htmlContent });
                        sessionStorage.setItem(cacheKey, cachePayload);
                        console.log(`Cached RSS feed for ${feedUrl}`);
                    } catch (e) {
                        console.error("Error writing RSS cache:", e);
                    }

                } catch (error) {
                    console.error(`Error fetching/parsing RSS feed via rss2json for ${feedUrl}:`, error);
                    feedItemsContainer.html(`<p>Error loading news feed: ${error.message || 'Unknown error'}</p>`);
                    // Optionally clear cache on error? Or leave stale cache? Leaving it for now.
                }
            }


            // --- Function to show a specific section ---
            function showSection(targetId, updateHistory = true) {
                const targetSection = $('#' + targetId);
                // Update cryptoOptions selector to include the new button
                const cryptoOptions = $('#crypto-menu .crypto-option');
                const targetOption = cryptoOptions.filter(`[data-target="${targetId}"]`);

                if (!targetSection.length) { return; } // Exit if target doesn't exist

                // Update trigger button text
                if (targetOption.length && cryptoMenuTrigger.text() !== targetOption.data('display')) {
                    cryptoMenuTrigger.text(targetOption.data('display'));
                }

                // Hide other sections and show the target
                const currentActiveSection = $('.crypto-content.active');
                if (currentActiveSection.attr('id') !== targetId) {
                   currentActiveSection.removeClass('active');
                   targetSection.addClass('active');
                }

                // --- Handle different section types ---
                if (targetId === 'market-table-section') {
                    // Load market table if the function exists
                    if (typeof loadCryptoMarketTable === 'function') {
                        loadCryptoMarketTable(); // Call function from market_table.js
                    } else {
                        console.error("loadCryptoMarketTable function not found!");
                        $('#crypto-market-table-container').html('<p class="error-message">Error: Table loading script missing.</p>');
                    }
                    // Clear any active price interval if switching away from a coin section
                    if (activePriceIntervalId) {
                        clearInterval(activePriceIntervalId);
                        activePriceIntervalId = null;
                        console.log("Cleared price interval when switching to market table.");
                    }
                     // Set page title for market table
                     if (typeof updatePageTitle === 'function') {
                         // We can reuse updatePageTitle, just pass a specific string for cryptoType
                         // and null for price. The function needs a slight modification
                         // OR we can just set document.title directly here. Let's set directly for simplicity.
                         document.title = 'Crypto Market Table - PassiveCash.xyz';
                     }

                } else {
                    // Logic for individual crypto sections (BTC, ETH, SOL)
                    const cryptoType = targetId.replace('-section', '');
                    const validTypes = ['btc', 'eth', 'sol']; // Keep this list updated

                    if (validTypes.includes(cryptoType)) {
                        const chartContainerId = (cryptoType === 'btc') ? 'chart' : `chart-${cryptoType}`;

                        // Initialize chart only if it hasn't been initialized yet
                        if (targetSection.data('chart-initialized') !== true) {
                            console.log(`Initializing chart for ${cryptoType} in #${chartContainerId}`);
                            if ($(`#${chartContainerId}`).length) {
                                 create_crypto_chart(cryptoType, chartContainerId);
                                 targetSection.data('chart-initialized', true);
                            } else {
                                 console.error(`Chart container #${chartContainerId} not found!`);
                            }
                        } else {
                             console.log(`Chart for ${cryptoType} already initialized.`);
                        }

                        // Always start/restart the ticker for the selected section
                        startTicker(cryptoType);

                        // --- Load RSS Feed ---
                        const feeds = {
                            btc: { url: 'https://www.reddit.com/r/Bitcoin/rising/.rss', container: 'btc-rss-feed' },
                            eth: { url: 'https://www.reddit.com/r/ethereum/rising/.rss', container: 'eth-rss-feed' },
                            sol: { url: 'https://www.reddit.com/r/solana/rising/.rss', container: 'sol-rss-feed' }
                        };
                        if (feeds[cryptoType]) {
                            if ($(`#${feeds[cryptoType].container}`).length) {
                                 console.log(`Fetching RSS feed for ${cryptoType}`);
                                 $(`#${feeds[cryptoType].container} .feed-items`).html('<p class="loading-text">Loading news...</p>');
                                 fetchAndDisplayRSS(feeds[cryptoType].url, feeds[cryptoType].container);
                            } else {
                                 console.error(`RSS feed container #${feeds[cryptoType].container} not found!`);
                            }
                        }
                    } else {
                         console.error("Could not derive valid cryptoType from targetId:", targetId);
                         // Optionally hide the section or show an error
                    }
                }

                // --- Update URL Hash ---
                // Determine hash based on targetId
                let newHashValue = '';
                if (targetId === 'market-table-section') {
                    newHashValue = 'market-table';
                } else {
                    // Assume it's a crypto section
                    newHashValue = targetId.replace('-section', '');
                }
                const newHash = '#' + newHashValue;
                const currentHash = window.location.hash;

                if (updateHistory && currentHash !== newHash) {
                    if (history.pushState) {
                        history.pushState(null, null, newHash);
                    } else {
                        window.location.hash = newHash; // Fallback
                    }
                }
            }

            // Handle option selection from dropdown
            cryptoOptions.on('click', function() {
                const targetId = $(this).data('target');
                cryptoMenu.removeClass('active'); // Hide menu
                showSection(targetId, true); // Show section and update history
            });

            // Close dropdown if clicking outside
            $(document).on('click', function(e) {
                if (!cryptoMenu.is(e.target) && cryptoMenu.has(e.target).length === 0 && !cryptoMenuTrigger.is(e.target)) {
                    cryptoMenu.removeClass('active');
                }
            });

            // --- Handle Hash on Page Load and Back/Forward ---
            function handleHashChange() {
                const hash = window.location.hash; // e.g., "#sol" or "#market-table"
                const validCryptoTypes = ['btc', 'eth', 'sol'];
                const validOtherHashes = ['market-table']; // Add other valid non-crypto hashes here
                let targetId = 'btc-section'; // Default target section

                if (hash && hash.length > 1) {
                    const potentialTarget = hash.substring(1); // Remove '#' -> "sol" or "market-table"

                    if (validCryptoTypes.includes(potentialTarget)) {
                        targetId = `${potentialTarget}-section`;
                    } else if (validOtherHashes.includes(potentialTarget)) {
                         // Map other valid hashes to their section IDs
                         if (potentialTarget === 'market-table') {
                             targetId = 'market-table-section';
                         }
                         // Add more else if blocks for other non-crypto sections if needed
                    } else {
                         console.warn(`Invalid hash detected: ${hash}. Defaulting to BTC section.`);
                         targetId = 'btc-section'; // Explicitly set default on invalid hash
                    }
                } else {
                     targetId = 'btc-section'; // Default if no hash
                }

                showSection(targetId, false); // Show section without updating history again
            }

            // Listen for hash changes (back/forward buttons)
            $(window).on('hashchange', handleHashChange);

            // Initial page load check
            handleHashChange();

            // Chart initialization would happen here or be triggered by the ticker scripts if needed
            // let btcChart, ethChart; // Define chart variables if needed for reflow
        });
    </script>

    <!-- Hamburger Menu Script is now in js/main.js -->

    <!-- Advertisement Script -->
    <script src="js/advertisement.js"></script>
    <script src="js/market_table.js"></script> <!-- Include market table script -->
    <script src="js/main.js"></script> <!-- Include consolidated main script -->

</body>
</html>
